<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Stickman Multiplayer</title>
<style>
body { margin: 0; overflow: hidden; background-color: #222233; }
#info { position: absolute; top: 10px; left: 10px; color: #fff; background: rgba(0,0,0,0.5); padding: 8px; border-radius: 5px; font-family: sans-serif; }
</style>
</head>
<body>
<div id="info">
<b>W</b>: forward &nbsp; <b>S</b>: backward &nbsp; <b>A</b>: left &nbsp; <b>D</b>: right<br>
<b>Shift</b>: run, <b>Space</b>: jump<br>
<b>1</b>: Third-person &nbsp; <b>2</b>: First-person &nbsp; <b>3</b>: Top-down view<br>
<b>Move mouse</b> to rotate camera, <b>Scroll</b> to zoom (except first-person)
</div>
<script src="https://cdn.jsdelivr.net/npm/three@0.154.0/build/three.min.js"></script>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
// --- Scene Setup ---
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x222233);
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(0,4,8);
let cameraMode = 1;
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);
scene.add(new THREE.AmbientLight(0xffffff, 0.7));
const directionalLight = new THREE.DirectionalLight(0xffffff, 0.7);
directionalLight.position.set(5,10,7.5);
scene.add(directionalLight);
const ground = new THREE.Mesh(new THREE.PlaneGeometry(100,100), new THREE.MeshStandardMaterial({color:0x444444}));
ground.rotation.x = -Math.PI/2;
scene.add(ground);

// --- Stickman Factory ---
function createStickman(color=0x181818) {
    const group = new THREE.Group();
    const stickMat = new THREE.MeshStandardMaterial({color});
    const headMat = new THREE.MeshStandardMaterial({color:0xffffff});

    // Head
    const head = new THREE.Mesh(new THREE.SphereGeometry(0.28,32,32), headMat);
    head.position.y=2.25; group.add(head);

    // Body
    const body = new THREE.Mesh(new THREE.CylinderGeometry(0.06,0.06,0.95,20), stickMat);
    body.position.y=1.5; group.add(body);

    // Arms and legs
    const leftArm = new THREE.Group(); leftArm.position.set(-0.19,1.9,0); group.add(leftArm);
    const upperArmL = new THREE.Mesh(new THREE.CylinderGeometry(0.045,0.045,0.49,14), stickMat);
    upperArmL.position.y=-0.245; leftArm.add(upperArmL);

    const rightArm = new THREE.Group(); rightArm.position.set(0.19,1.9,0); group.add(rightArm);
    const upperArmR = new THREE.Mesh(new THREE.CylinderGeometry(0.045,0.045,0.49,14), stickMat);
    upperArmR.position.y=-0.245; rightArm.add(upperArmR);

    const leftLeg = new THREE.Group(); leftLeg.position.set(-0.07,0.99,0); group.add(leftLeg);
    const upperLegL = new THREE.Mesh(new THREE.CylinderGeometry(0.055,0.055,0.58,14), stickMat);
    upperLegL.position.y=-0.29; leftLeg.add(upperLegL);

    const rightLeg = new THREE.Group(); rightLeg.position.set(0.07,0.99,0); group.add(rightLeg);
    const upperLegR = new THREE.Mesh(new THREE.CylinderGeometry(0.055,0.055,0.58,14), stickMat);
    upperLegR.position.y=-0.29; rightLeg.add(upperLegR);

    group.userData = {leftArm,rightArm,leftLeg,rightLeg};
    return group;
}

const player = createStickman();
scene.add(player);

// Multiplayer setup
const socket = io('https://your-server-address'); // Replace with your server
let otherPlayers = {};
socket.on('update', data => {
    for(const id in data) {
        if(id===socket.id) continue;
        if(!otherPlayers[id]){
            const sp = createStickman(0xff0000);
            scene.add(sp);
            otherPlayers[id]=sp;
        }
        otherPlayers[id].position.set(data[id].x,data[id].y,data[id].z);
    }
});

// --- Movement ---
let moveF=0, moveB=0, moveL=0, moveR=0;
let isJump=false, velY=0, grounded=true;
const speed=0.08, runMultiplier=2, jumpStrength=0.24, gravity=0.012;
window.addEventListener('keydown', e=>{
    if(e.key==='w') moveF=1;
    if(e.key==='s') moveB=1;
    if(e.key==='a') moveL=1;
    if(e.key==='d') moveR=1;
    if(e.key===' ') { if(grounded){isJump=true;velY=jumpStrength;grounded=false;} }
});
window.addEventListener('keyup', e=>{
    if(e.key==='w') moveF=0;
    if(e.key==='s') moveB=0;
    if(e.key==='a') moveL=0;
    if(e.key==='d') moveR=0;
});

// Camera
let az=0, polar=Math.PI/5, rad=8;
function updateCamera(){
    const px=player.position.x, py=player.position.y, pz=player.position.z;
    let cx=px+rad*Math.sin(polar)*Math.sin(az);
    let cy=py+rad*Math.cos(polar)+1;
    let cz=pz+rad*Math.sin(polar)*Math.cos(az);
    camera.position.set(cx,cy,cz);
    camera.lookAt(px,py+1.4,pz);
}

// --- Animation ---
let walkCycle=0;
function animateStickman(){
    walkCycle+=0.05;
}

// --- Main Loop ---
function animate(){
    requestAnimationFrame(animate);
    let dx=(moveF-moveB)*speed, dz=(moveR-moveL)*speed;
    player.position.x+=dx; player.position.z+=dz;
    if(isJump){ player.position.y+=velY; velY-=gravity; if(player.position.y<=0){player.position.y=0; isJump=false; grounded=true; velY=0;} }
    socket.emit('move',{x:player.position.x,y:player.position.y,z:player.position.z});
    updateCamera();
    animateStickman();
    renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>

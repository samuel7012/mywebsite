<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Multiplayer Stickman</title>
<style>
body { margin: 0; overflow: hidden; background: #000; }
#info { position: absolute; top: 10px; left: 10px; color: #fff; background: rgba(0,0,0,0.5); padding: 8px; border-radius: 5px; font-family: sans-serif; }
</style>
</head>
<body>
<div id="info">
<b>WASD</b> move | <b>Shift</b> run | <b>Space</b> jump
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.154.0/build/three.min.js"></script>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<script>

// ====== SCENE SETUP ======
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x222233);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(0, 4, 8);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffffff, 0.7));
const directionalLight = new THREE.DirectionalLight(0xffffff, 0.7);
directionalLight.position.set(5, 10, 7.5);
scene.add(directionalLight);

const ground = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshStandardMaterial({ color: 0x444444 }));
ground.rotation.x = -Math.PI/2;
scene.add(ground);

// ====== STICKMAN CREATION FUNCTION ======
function createStickman(color=0x181818) {
  const stickman = new THREE.Group();
  const stickMat = new THREE.MeshStandardMaterial({color});
  const headMat = new THREE.MeshStandardMaterial({color: 0xffffff});

  const head = new THREE.Mesh(new THREE.SphereGeometry(0.28, 32, 32), headMat);
  head.position.y = 2.25; stickman.add(head);

  const body = new THREE.Mesh(new THREE.CylinderGeometry(0.06, 0.06, 0.95, 20), stickMat);
  body.position.y = 1.5; stickman.add(body);

  const shoulders = new THREE.Mesh(new THREE.SphereGeometry(0.09, 20, 16), stickMat);
  shoulders.position.y = 1.98; stickman.add(shoulders);

  const hips = new THREE.Mesh(new THREE.SphereGeometry(0.085, 18, 12), stickMat);
  hips.position.y = 1.02; stickman.add(hips);

  // Left Arm
  const leftArm = new THREE.Group();
  leftArm.position.set(-0.19, 1.9, 0); stickman.add(leftArm);
  const upperArmL = new THREE.Mesh(new THREE.CylinderGeometry(0.045, 0.045, 0.49, 14), stickMat);
  upperArmL.position.y = -0.245; leftArm.add(upperArmL);
  const elbowL = new THREE.Mesh(new THREE.SphereGeometry(0.06, 12, 10), stickMat);
  elbowL.position.y = -0.49; leftArm.add(elbowL);
  const leftForearm = new THREE.Group(); leftForearm.position.y = -0.49;
  const lowerArmL = new THREE.Mesh(new THREE.CylinderGeometry(0.04, 0.04, 0.42, 12), stickMat);
  lowerArmL.position.y = -0.21; leftForearm.add(lowerArmL);
  const handL = new THREE.Mesh(new THREE.SphereGeometry(0.045, 10, 8), stickMat);
  handL.position.y = -0.42; leftForearm.add(handL);
  leftArm.add(leftForearm);

  // Right Arm
  const rightArm = new THREE.Group();
  rightArm.position.set(0.19, 1.9, 0); stickman.add(rightArm);
  const upperArmR = new THREE.Mesh(new THREE.CylinderGeometry(0.045, 0.045, 0.49, 14), stickMat);
  upperArmR.position.y = -0.245; rightArm.add(upperArmR);
  const elbowR = new THREE.Mesh(new THREE.SphereGeometry(0.06, 12, 10), stickMat);
  elbowR.position.y = -0.49; rightArm.add(elbowR);
  const rightForearm = new THREE.Group(); rightForearm.position.y = -0.49;
  const lowerArmR = new THREE.Mesh(new THREE.CylinderGeometry(0.04, 0.04, 0.42, 12), stickMat);
  lowerArmR.position.y = -0.21; rightForearm.add(lowerArmR);
  const handR = new THREE.Mesh(new THREE.SphereGeometry(0.045, 10, 8), stickMat);
  handR.position.y = -0.42; rightForearm.add(handR);
  rightArm.add(rightForearm);

  // Left Leg
  const leftLeg = new THREE.Group();
  leftLeg.position.set(-0.07, 0.99, 0); stickman.add(leftLeg);
  const upperLegL = new THREE.Mesh(new THREE.CylinderGeometry(0.055, 0.055, 0.58, 14), stickMat);
  upperLegL.position.y = -0.29; leftLeg.add(upperLegL);
  const kneeL = new THREE.Mesh(new THREE.SphereGeometry(0.07, 12, 8), stickMat);
  kneeL.position.y = -0.58; leftLeg.add(kneeL);
  const leftShin = new THREE.Group(); leftShin.position.y = -0.58;
  const lowerLegL = new THREE.Mesh(new THREE.CylinderGeometry(0.045, 0.045, 0.49, 12), stickMat);
  lowerLegL.position.y = -0.245; leftShin.add(lowerLegL);
  const footL = new THREE.Mesh(new THREE.SphereGeometry(0.05, 10, 8), stickMat);
  footL.position.y = -0.49; leftShin.add(footL);
  leftLeg.add(leftShin);

  // Right Leg
  const rightLeg = new THREE.Group();
  rightLeg.position.set(0.07, 0.99, 0); stickman.add(rightLeg);
  const upperLegR = new THREE.Mesh(new THREE.CylinderGeometry(0.055, 0.055, 0.58, 14), stickMat);
  upperLegR.position.y = -0.29; rightLeg.add(upperLegR);
  const kneeR = new THREE.Mesh(new THREE.SphereGeometry(0.07, 12, 8), stickMat);
  kneeR.position.y = -0.58; rightLeg.add(kneeR);
  const rightShin = new THREE.Group(); rightShin.position.y = -0.58;
  const lowerLegR = new THREE.Mesh(new THREE.CylinderGeometry(0.045, 0.045, 0.49, 12), stickMat);
  lowerLegR.position.y = -0.245; rightShin.add(lowerLegR);
  const footR = new THREE.Mesh(new THREE.SphereGeometry(0.05, 10, 8), stickMat);
  footR.position.y = -0.49; rightShin.add(footR);
  rightLeg.add(rightShin);

  return stickman;
}

// ====== CREATE LABEL ======
function createLabel(text) {
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");
  ctx.font = "20px Arial";
  const width = ctx.measureText(text).width + 20;
  canvas.width = width;
  canvas.height = 40;
  ctx.font = "20px Arial";
  ctx.fillStyle = "white";
  ctx.textAlign = "center";
  ctx.fillText(text, canvas.width / 2, 25);

  const texture = new THREE.CanvasTexture(canvas);
  const material = new THREE.SpriteMaterial({ map: texture, transparent: true });
  const sprite = new THREE.Sprite(material);
  sprite.scale.set(2, 1, 1);
  sprite.position.set(0, 3, 0);
  return sprite;
}

// ====== MY PLAYER ======
const myPlayer = createStickman(0x0077ff); // blue
const myLabel = createLabel("You");
myPlayer.add(myLabel);
scene.add(myPlayer);

// ====== MOVEMENT ======
let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
let isRunning = false;
let velocityY = 0;
let isGrounded = true;
const walkSpeed = 0.08, runSpeed = 0.16, jumpStrength = 0.24, gravity = 0.012;

document.addEventListener("keydown", (e) => {
  if (e.key === "w") moveForward = true;
  if (e.key === "s") moveBackward = true;
  if (e.key === "a") moveLeft = true;
  if (e.key === "d") moveRight = true;
  if (e.key === "Shift") isRunning = true;
  if (e.key === " " && isGrounded) { velocityY = jumpStrength; isGrounded = false; }
});
document.addEventListener("keyup", (e) => {
  if (e.key === "w") moveForward = false;
  if (e.key === "s") moveBackward = false;
  if (e.key === "a") moveLeft = false;
  if (e.key === "d") moveRight = false;
  if (e.key === "Shift") isRunning = false;
});

// ====== MULTIPLAYER SOCKET.IO ======
const socket = io("http://localhost:3000");
let otherPlayers = {};

socket.on("init", (players) => {
  for (let id in players) {
    if (id !== socket.id) addPlayer(id, players[id]);
  }
});
socket.on("newPlayer", ({ id, pos }) => addPlayer(id, pos));
socket.on("updatePlayer", ({ id, pos }) => {
  if (otherPlayers[id]) otherPlayers[id].position.set(pos.x, pos.y, pos.z);
});
socket.on("removePlayer", (id) => {
  if (otherPlayers[id]) { scene.remove(otherPlayers[id]); delete otherPlayers[id]; }
});

function addPlayer(id, pos) {
  const clone = createStickman(0xff3333); // red
  const label = createLabel(id);
  clone.add(label);
  clone.position.set(pos.x, pos.y, pos.z);
  scene.add(clone);
  otherPlayers[id] = clone;
}

// ====== GAME LOOP ======
function animate() {
  requestAnimationFrame(animate);

  let speed = isRunning ? runSpeed : walkSpeed;
  if (moveForward) myPlayer.position.z -= speed;
  if (moveBackward) myPlayer.position.z += speed;
  if (moveLeft) myPlayer.position.x -= speed;
  if (moveRight) myPlayer.position.x += speed;

  myPlayer.position.y += velocityY;
  velocityY -= gravity;
  if (myPlayer.position.y <= 0) { myPlayer.position.y = 0; isGrounded = true; velocityY = 0; }

  camera.position.x = myPlayer.position.x + 5;
  camera.position.z = myPlayer.position.z + 8;
  camera.lookAt(myPlayer.position);

  socket.emit("move", { x: myPlayer.position.x, y: myPlayer.position.y, z: myPlayer.position.z });

  renderer.render(scene, camera);
}
animate();

window.addEventListener("resize", () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

</script>
</body>
</html>
